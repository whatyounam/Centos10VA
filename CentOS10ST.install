#!/bin/bash
# CentOS Stream 9 Full Panel Installer
# Features: nginx + php8.2 (Remi) + MariaDB 10.11 + phpMyAdmin + TinyFileManager + certbot + firewall safe + creds backup
set -euo pipefail
IFS=$'\n\t'

# --- UI ---
logo(){
  echo -e "\e[1;35m
   ____      _   _  _   _   ____   __  __
  / ___| ___| |_| \| | | \ | |  _ \|  \/  |
 | |  _ / _ \ __| .\` | |  \| | | | | |\/| |
 | |_| |  __/ |_| |\  | | |\  | |_| | |  | |
  \____|\___|\__|_| \_| |_| \_|____/|_|  |_|
  \e[0m"
  echo -e "\e[1;36m  Viá»‡t_Anh_Codeâ„¢ â€” CentOS9 Panel Full Installer\e[0m"
  echo
}

# --- root check
if [ "$(id -u)" -ne 0 ]; then
  echo "âš ï¸  Cháº¡y vá»›i quyá»n root nhÃ© (sudo su)"
  exit 1
fi

logo
echo "ðŸš€ Báº¯t Ä‘áº§u cÃ i Ä‘áº·t â€” script sáº½ há»i vÃ i thÃ´ng tin..."

# --- Ask inputs
read -p "Nháº­p domain ( Náº¿u ChÆ°a Trá» TÃªn Miá»n Vá» Ip MÃ¡y MÃ  Nháº­p VÃ o ÄÃ¢y ThÃ¬ Script Sáº½ Káº¿t ThÃºc ) - (VD: domain.com) hoáº·c ENTER Ä‘á»ƒ dÃ¹ng IP: " ADMIN_DOMAIN
read -p "Port panel (máº·c Ä‘á»‹nh 2025): " ADMIN_PORT
ADMIN_PORT=${ADMIN_PORT:-2025}
read -p "Web admin username (máº·c Ä‘á»‹nh: admin): " WEB_ADMIN_USER
WEB_ADMIN_USER=${WEB_ADMIN_USER:-admin}

# Generate passwords
PANEL_DB="panel_db"
PANEL_USER="panel_user"
PANEL_PASS=$(openssl rand -base64 12)
WEB_ADMIN_PASS=$(openssl rand -base64 12)
MYSQL_ROOT_PASS=$(openssl rand -base64 16)

# Detect primary IP (first non-loopback)
PRIMARY_IP=$(ip -4 addr show scope global | awk '/inet /{print $2}' | cut -d/ -f1 | head -n1 || echo "127.0.0.1")
echo "IP mÃ¡y hiá»‡n táº¡i: $PRIMARY_IP"

# Ask extra allowed IP (so you don't lock yourself)
read -p "Nháº­p 1 IP khÃ¡c Ä‘Æ°á»£c phÃ©p truy cáº­p panel (hoáº·c ENTER Ä‘á»ƒ chá»‰ cho phÃ©p IP nÃ y mÃ¡y): " EXTRA_IP

# --- Prepare system
echo "ðŸ§¹ Clean & update há»‡ thá»‘ng..."
dnf -y clean all
dnf -y update
dnf -y install epel-release wget curl unzip git nano dnf-plugins-core

# --- Remi PHP 8.2
echo "ðŸ“¦ CÃ i Remi (PHP 8.2)..."
dnf -y install https://rpms.remirepo.net/enterprise/remi-release-9.rpm
dnf module reset -y php || true
dnf module enable -y php:remi-8.2

# --- MariaDB repo (10.11) for RHEL9
echo "ðŸ§± Cáº¥u hÃ¬nh repo MariaDB 10.11..."
cat > /etc/yum.repos.d/MariaDB.repo <<'EOF'
[mariadb]
name = MariaDB
baseurl = https://mirror.mariadb.org/yum/10.11/rhel9-amd64
gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB
gpgcheck=1
enabled=1
EOF

dnf -y makecache

# --- Install core packages
echo "ðŸ”§ CÃ i Nginx, PHP-FPM, MariaDB..."
dnf -y install nginx php php-cli php-fpm php-mysqlnd php-xml php-gd php-mbstring php-curl php-json php-zip mariadb-server

# Enable services
systemctl enable --now nginx php-fpm mariadb

# --- Secure MariaDB + create DB/user
echo "ðŸ”’ Thiáº¿t láº­p MariaDB..."
# start mysqld if not running
systemctl start mariadb || true
# set root password and create panel db + user (if root has empty password this will succeed)
mysql -u root <<SQL || true
ALTER USER 'root'@'localhost' IDENTIFIED BY '${MYSQL_ROOT_PASS}';
FLUSH PRIVILEGES;
CREATE DATABASE IF NOT EXISTS ${PANEL_DB};
CREATE USER IF NOT EXISTS '${PANEL_USER}'@'localhost' IDENTIFIED BY '${PANEL_PASS}';
GRANT ALL PRIVILEGES ON ${PANEL_DB}.* TO '${PANEL_USER}'@'localhost';
FLUSH PRIVILEGES;
SQL

# --- phpMyAdmin
echo "ðŸ“š CÃ i phpMyAdmin..."
mkdir -p /var/www/html/phpmyadmin
PHPMYADMIN_VER="5.2.1"
wget -qO /tmp/phpmyadmin.zip "https://files.phpmyadmin.net/phpMyAdmin/${PHPMYADMIN_VER}/phpMyAdmin-${PHPMYADMIN_VER}-all-languages.zip"
unzip -q /tmp/phpmyadmin.zip -d /tmp/
rm -rf /var/www/html/phpmyadmin/*
mv /tmp/phpMyAdmin-${PHPMYADMIN_VER}-all-languages/* /var/www/html/phpmyadmin/
rm -rf /tmp/phpMyAdmin-${PHPMYADMIN_VER}-all-languages /tmp/phpmyadmin.zip
chown -R nginx:nginx /var/www/html/phpmyadmin
chmod -R 755 /var/www/html/phpmyadmin

# --- TinyFileManager
echo "ðŸ—‚ï¸ CÃ i TinyFileManager..."
mkdir -p /var/www/html/filemanager
wget -qO /var/www/html/filemanager/index.php "https://github.com/prasathmani/tinyfilemanager/releases/download/2.4.13/tinyfilemanager.php"
cat > /var/www/html/filemanager/tfm-config.php <<EOF
<?php
\$username = '${WEB_ADMIN_USER}';
\$password = '${WEB_ADMIN_PASS}';
\$salt = '';
\$upload_dir = __DIR__;
?>
EOF
chown -R nginx:nginx /var/www/html/filemanager
chmod -R 755 /var/www/html/filemanager

# --- Nginx panel config
echo "ðŸ› ï¸ Cáº¥u hÃ¬nh Nginx cho panel á»Ÿ port ${ADMIN_PORT}..."
PHP_FPM_SOCK="/run/php-fpm/www.sock"
cat > /etc/nginx/conf.d/panel.conf <<EOF
server {
    listen ${ADMIN_PORT} default_server;
    server_name ${ADMIN_DOMAIN:-_};
    root /var/www/html;
    index index.php index.html index.htm;

    location / {
        try_files \$uri \$uri/ =404;
    }

    location ~ \.php\$ {
        include fastcgi_params;
        fastcgi_pass unix:${PHP_FPM_SOCK};
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }

    location ^~ /phpmyadmin {
        root /var/www/html;
        index index.php;
        location ~ \.php\$ {
            include fastcgi_params;
            fastcgi_pass unix:${PHP_FPM_SOCK};
            fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        }
    }

    location ^~ /filemanager {
        root /var/www/html;
        index index.php;
    }
}
EOF

nginx -t && systemctl reload nginx

# --- Firewall setup (safe) ---
echo "ðŸ” Cáº¥u hÃ¬nh firewalld an toÃ n..."
systemctl enable --now firewalld
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --permanent --add-port=${ADMIN_PORT}/tcp
# always ensure SSH port 22 allowed; we'll not change SSH port automatically here
firewall-cmd --permanent --add-service=ssh

# Allow primary IP and extra IP (if provided)
ALLOWED=("${PRIMARY_IP}")
if [ -n "${EXTRA_IP:-}" ]; then ALLOWED+=("${EXTRA_IP}"); fi

# Remove any previous panel drop rule (best-effort)
firewall-cmd --permanent --remove-rich-rule="rule family='ipv4' port port=${ADMIN_PORT} protocol=tcp drop" 2>/dev/null || true

for ip in "${ALLOWED[@]}"; do
  ip=$(echo "$ip" | xargs)
  firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='${ip}' port port=${ADMIN_PORT} protocol=tcp accept"
done

# finally drop others
firewall-cmd --permanent --add-rich-rule="rule family='ipv4' port port=${ADMIN_PORT} protocol=tcp drop"
firewall-cmd --reload

# --- SSL via Certbot (optional)
if [ -n "${ADMIN_DOMAIN}" ]; then
  echo "ðŸ” CÃ i certbot vÃ  request Let's Encrypt cho ${ADMIN_DOMAIN}..."
  dnf -y install certbot python3-certbot-nginx
  # try to obtain cert (will fail if domain not pointed)
  if ping -c1 "${ADMIN_DOMAIN}" >/dev/null 2>&1; then
    certbot --nginx -d "${ADMIN_DOMAIN}" --non-interactive --agree-tos -m admin@"${ADMIN_DOMAIN}" --redirect || echo "âš ï¸ Certbot failed â€” domain cÃ³ thá»ƒ chÆ°a trá» Ä‘Ãºng."
    systemctl reload nginx || true
  else
    echo "âš ï¸ Domain ${ADMIN_DOMAIN} chÆ°a trá» tá»›i server â€” bá» qua cÃ i SSL."
  fi
fi

# --- Save credentials
echo "ðŸ’¾ LÆ°u thÃ´ng tin Ä‘Äƒng nháº­p vÃ o /root/panel_install_backup/panel_credentials.txt"
mkdir -p /root/panel_install_backup
cat > /root/panel_install_backup/panel_credentials.txt <<EOF
SSH (unchanged): use your server SSH credentials
Panel port: ${ADMIN_PORT}
Panel URL: http://${ADMIN_DOMAIN:-$PRIMARY_IP}:${ADMIN_PORT}
phpMyAdmin: http://${ADMIN_DOMAIN:-$PRIMARY_IP}:${ADMIN_PORT}/phpmyadmin
FileManager: http://${ADMIN_DOMAIN:-$PRIMARY_IP}:${ADMIN_PORT}/filemanager

MySQL root: ${MYSQL_ROOT_PASS}
Database: ${PANEL_DB}
DB user: ${PANEL_USER}
DB pass: ${PANEL_PASS}

Web admin user: ${WEB_ADMIN_USER}
Web admin pass: ${WEB_ADMIN_PASS}
EOF
chmod 600 /root/panel_install_backup/panel_credentials.txt

# --- Final message + reboot prompt
echo
echo "ðŸŽ‰ HoÃ n táº¥t! Kiá»ƒm tra /root/panel_install_backup/panel_credentials.txt Ä‘á»ƒ láº¥y thÃ´ng tin."
echo "Truy cáº­p panel: http://${ADMIN_DOMAIN:-$PRIMARY_IP}:${ADMIN_PORT}"
echo
read -p "Nháº¥n Enter Ä‘á»ƒ reboot (hoáº·c Ctrl+C Ä‘á»ƒ giá»¯ láº¡i vÃ  kiá»ƒm tra)..."
reboot
