#!/bin/bash
set -e

# ===== Logo Cyberpunk =====
logo() {
clear
echo -e "\e[5;38;5;45m  ____  _   _  _____ _   _  _   _   ____  _   _  ____ \e[0m"
echo -e "\e[5;38;5;213m |  _ \\| \\ | || ____| \\ | || \\ | | / ___|| | | |/ ___| \e[0m"
echo -e "\e[5;38;5;45m | |_) |  \\| ||  _| |  \\| ||  \\| | \\___ \\| | | | |  _  \e[0m"
echo -e "\e[5;38;5;213m |  __/| |\\  || |___| |\\  || |\\  |  ___) | |_| | |_| | \e[0m"
echo -e "\e[5;38;5;201m |_|   |_| \\_||_____|_| \\_||_| \\_| |____/ \\___/ \\____| \e[0m"
echo -e "\e[5;38;5;45m      ðŸ‘‘ Viá»‡t_Anh_Codeâ„¢ | CentOS 9 Full V2+\e[0m"
}
logo

echo "ðŸš€ Báº¯t Ä‘áº§u cÃ i Ä‘áº·t Panel Server CentOS 9..."
echo " LÆ°u Ã: Náº¿u domain chÆ°a trá» vá» IP nÃ y, Ä‘á»ƒ trá»‘ng Ä‘á»ƒ truy cáº­p báº±ng IP"
echo "--------------------------------------------------"

# ===== Root check =====
if [ $(id -u) != "0" ]; then
    echo "âŒ Cáº§n cháº¡y báº±ng quyá»n root!"
    exit 1
fi

# ===== Nháº­p domain + port =====
read -p "Nháº­p domain quáº£n trá»‹ server (hoáº·c Ä‘á»ƒ trá»‘ng dÃ¹ng IP): " ADMIN_DOMAIN
read -p "Nháº­p port quáº£n trá»‹ server (VD:2025): " ADMIN_PORT

# ===== User Web admin =====
WEB_ADMIN_USER="admin"
WEB_ADMIN_PASS=$(openssl rand -base64 12)

# ===== Random DB & MariaDB =====
PANEL_DB="panel_db"
PANEL_USER="panel_user"
PANEL_PASS=$(openssl rand -base64 12)
MYSQL_ROOT_PASS=$(openssl rand -base64 16)

# ===== Backup & chuáº©n repo CentOS 9 =====
mkdir -p /etc/yum.repos.d/backup
mv /etc/yum.repos.d/CentOS-*.repo /etc/yum.repos.d/backup/ 2>/dev/null || true

cat > /etc/yum.repos.d/CentOS-Stream-9.repo <<EOF
[BaseOS]
name=CentOS Stream 9 - BaseOS
baseurl=https://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial

[AppStream]
name=CentOS Stream 9 - AppStream
baseurl=https://mirror.stream.centos.org/9-stream/AppStream/x86_64/os/
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
EOF

dnf clean all && dnf makecache

# ===== CÃ i PHP/Nginx/MariaDB =====
dnf install -y epel-release wget yum-utils git
dnf install -y php php-cli php-fpm php-mysqlnd php-mbstring php-xml php-gd php-curl nginx mariadb-server mariadb
systemctl enable --now php-fpm nginx mariadb
systemctl start mariadb

# ===== MariaDB setup =====
mysql -u root <<EOF
ALTER USER 'root'@'localhost' IDENTIFIED BY '${MYSQL_ROOT_PASS}';
FLUSH PRIVILEGES;
CREATE DATABASE IF NOT EXISTS ${PANEL_DB};
CREATE USER IF NOT EXISTS '${PANEL_USER}'@'localhost' IDENTIFIED BY '${PANEL_PASS}';
GRANT ALL PRIVILEGES ON ${PANEL_DB}.* TO '${PANEL_USER}'@'localhost';
FLUSH PRIVILEGES;
EOF

# ===== phpMyAdmin =====
mkdir -p /var/www/html/phpmyadmin
wget -O /tmp/phpmyadmin.zip https://files.phpmyadmin.net/phpMyAdmin/5.2.1/phpMyAdmin-5.2.1-all-languages.zip
unzip /tmp/phpmyadmin.zip -d /var/www/html/phpmyadmin/
mv /var/www/html/phpmyadmin/phpMyAdmin-5.2.1-all-languages/* /var/www/html/phpmyadmin/
rm -rf /var/www/html/phpmyadmin/phpMyAdmin-5.2.1-all-languages /tmp/phpmyadmin.zip
chown -R nginx:nginx /var/www/html/phpmyadmin
chmod -R 755 /var/www/html/phpmyadmin

# ===== FileManager fallback =====
FM_DIR="/var/www/html/filemanager"
mkdir -p $FM_DIR
git clone https://github.com/hocvps/FileManager.git $FM_DIR || wget -O $FM_DIR/index.php https://github.com/prasathmani/tinyfilemanager/releases/download/2.4.13/tinyfilemanager.php

cat > "$FM_DIR/tfm-config.php" <<EOF
<?php
\$username = '$WEB_ADMIN_USER';
\$password = '$WEB_ADMIN_PASS';
\$salt = '';
\$upload_dir = __DIR__;
?>
EOF
chown -R nginx:nginx $FM_DIR
chmod -R 755 $FM_DIR

# ===== Nginx panel config =====
PHP_FPM_SOCK="/run/php-fpm/www.sock"
cat > /etc/nginx/conf.d/panel.conf <<EOF
server {
    listen ${ADMIN_PORT};
    server_name ${ADMIN_DOMAIN:-_};
    root /var/www/html;
    index index.php index.html index.htm;
    location / { try_files \$uri \$uri/ =404; }
    location ~ \.php\$ {
        include fastcgi_params;
        fastcgi_pass unix:${PHP_FPM_SOCK};
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }
}
EOF
nginx -t && systemctl restart nginx

# ===== Firewall chá»‰ 2 IP =====
PRIMARY_IP=$(hostname -I | awk '{print $1}')
echo "IP gá»‘c cá»§a mÃ¡y: $PRIMARY_IP"
read -p "Nháº­p 1 IP khÃ¡c Ä‘Æ°á»£c phÃ©p truy cáº­p panel: " EXTRA_IP
ALLOWED_IPS=("$PRIMARY_IP" "$EXTRA_IP")
firewall-cmd --permanent --add-port=$ADMIN_PORT/tcp
for ip in "${ALLOWED_IPS[@]}"; do
    firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='$ip' port port=${ADMIN_PORT} protocol=tcp accept"
done
firewall-cmd --permanent --add-rich-rule="rule family='ipv4' port port=${ADMIN_PORT} protocol=tcp drop"
firewall-cmd --reload

# ===== Backup credentials =====
mkdir -p /root/panel_install_backup
cat > /root/panel_install_backup/panel_credentials.txt <<EOF
SSH port: 22
MySQL root: $MYSQL_ROOT_PASS
Database panel: $PANEL_DB
DB user: $PANEL_USER
DB password: $PANEL_PASS
Web admin user: $WEB_ADMIN_USER
Web admin password: $WEB_ADMIN_PASS
Panel URL: http://${ADMIN_DOMAIN:-$PRIMARY_IP}:${ADMIN_PORT}
phpMyAdmin: http://${ADMIN_DOMAIN:-$PRIMARY_IP}:${ADMIN_PORT}/phpmyadmin
FileManager: http://${ADMIN_DOMAIN:-$PRIMARY_IP}:${ADMIN_PORT}/filemanager
EOF
chmod 600 /root/panel_install_backup/panel_credentials.txt

# ===== HoÃ n táº¥t =====
echo ""
echo "ðŸŽ‰ HoÃ n táº¥t cÃ i Ä‘áº·t! ThÃ´ng tin Ä‘Äƒng nháº­p:"
cat /root/panel_install_backup/panel_credentials.txt
echo ""
read -p "Nháº¥n Enter Ä‘á»ƒ reboot mÃ¡y Ã¡p dá»¥ng toÃ n bá»™ cÃ i Ä‘áº·t..."
reboot
